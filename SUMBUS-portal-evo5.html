<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>SÜMBÜS · System Architect</title>
  <link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#000204">
<link rel="apple-touch-icon" href="./icon-192.png">

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log('Service Worker Registered'));
  }
</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <script type="module">
    import {EditorView, basicSetup} from "https://codemirror.net/6/codemirror.js";
    import {html} from "https://codemirror.net/6/lang-html.js";
    import {oneDark} from "https://codemirror.net/6/theme-one-dark.js";
    window.CM = { EditorView, basicSetup, html, oneDark };
  </script>

  <style>
    :root {
      --glass-bg: rgba(7, 10, 15, 0.8);
      --glass-border: rgba(255, 255, 255, 0.08);
      --accent: #3b82f6;
      --critical: #ef4444;
      --warning: #f59e0b;
    }

    body {
      background: #02040a;
      color: #f8fafc;
      font-family: 'Inter', system-ui, sans-serif;
      margin: 0;
      overflow: hidden;
    }

    /* DRAGGABLE TRIGGER */
    #sumbus-trigger {
      position: fixed;
      left: 20px;
      bottom: 20px;
      width: 60px;
      height: 60px;
      border-radius: 20px;
      background: linear-gradient(135deg, #2563eb, #1e40af);
      cursor: grab;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 30px rgba(37, 99, 235, 0.4);
      touch-action: none;
      transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 2px solid rgba(255,255,255,0.1);
    }
    #sumbus-trigger:active { cursor: grabbing; transform: scale(0.9); }

    /* DECK OVERLAY */
    #sumbus-deck {
      position: fixed;
      inset: 0;
      background: rgba(1, 2, 4, 0.9);
      backdrop-filter: blur(40px);
      z-index: 9999;
      display: none;
      opacity: 0;
      transition: all 0.3s ease;
      grid-template-columns: 440px 1fr;
    }
    #sumbus-deck.active { display: grid; opacity: 1; }

    .sidebar {
      background: #070a0f;
      border-right: 1px solid var(--glass-border);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .tab-btn {
      flex: 1;
      padding: 12px;
      font-size: 10px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #475569;
      border-bottom: 2px solid transparent;
      transition: 0.2s;
    }
    .tab-btn.active { color: #3b82f6; border-color: #3b82f6; background: rgba(59, 130, 246, 0.05); }

    .panel { display: none; flex-direction: column; flex: 1; overflow-y: auto; padding: 24px; }
    .panel.active { display: flex; }

    .status-badge {
      font-size: 8px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 900;
      text-transform: uppercase;
    }

    .conflict-card {
      background: rgba(239, 68, 68, 0.05);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 8px;
    }

    /* CM Editor Fix */
    .cm-editor { height: 100%; border-radius: 8px; font-family: 'JetBrains Mono', monospace; }

    /* PREVIEW FRAME */
    .preview-area { padding: 20px; display: flex; flex-direction: column; gap: 12px; position: relative; }
    #main-iframe {
      background: white;
      border-radius: 16px;
      box-shadow: 0 40px 80px -20px rgba(0,0,0,0.8);
      width: 100%;
      height: 100%;
      border: none;
      transition: max-width 0.4s ease;
    }

    .scan-line {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: rgba(59, 130, 246, 0.5);
      box-shadow: 0 0 15px #3b82f6;
      z-index: 10;
      display: none;
    }
    .scanning .scan-line { display: block; animation: scan 2s linear infinite; }
    @keyframes scan { from { top: 0%; } to { top: 100%; } }


@media (max-width: 768px) {
  body {
    overflow: hidden;
  }

  #sumbus-deck {
    grid-template-columns: 1fr;
    overflow-x: hidden;
    overflow-y: auto;
    height: 100vh;
    -webkit-overflow-scrolling: touch;
  }

  .sidebar {
    height: auto;
  }

  .preview-area {
    min-height: 60vh;
  }
}

  </style>
</head>
<body>

  <!-- FLOATING TRIGGER -->
  <div id="sumbus-trigger" title="Drag to Move · Click to Open">
    <i data-lucide="shield-check" width="30" class="text-white"></i>
  </div>

  <!-- SÜMBÜS INTERFACE -->
  <div id="sumbus-deck">
    
    <div class="sidebar">
      <div class="p-6 border-b border-white/5 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-blue-600 flex items-center justify-center font-black text-xl italic shadow-lg shadow-blue-600/40">S</div>
          <div>
            <h1 class="font-black text-white text-xl tracking-tighter">SÜMBÜS</h1>
            <p class="text-[8px] text-blue-400 font-mono uppercase tracking-[0.2em]">Recursive Architecture</p>
          </div>
        </div>
        <button onclick="recursiveLoop()" class="p-2 bg-slate-800 hover:bg-blue-600 rounded-lg transition" title="Recursive Loop: Promover Resultado para Base">
          <i data-lucide="refresh-cw" width="16"></i>
        </button>
      </div>

      <div class="flex border-b border-white/5 bg-black/20">
        <button class="tab-btn active" onclick="showTab('build')">Build</button>
        <button class="tab-btn" onclick="showTab('scan')">Spatial Scan</button>
        <button class="tab-btn" onclick="showTab('code')">Code</button>
      </div>

      <!-- BUILD PANEL -->
      <div id="panel-build" class="panel active">
        <div class="space-y-6">
          <section>
            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-3">Base System</label>
            <div class="bg-white/5 border border-dashed border-white/10 rounded-xl p-4 text-center cursor-pointer hover:bg-white/10 transition group relative">
              <input type="file" id="base-input" class="absolute inset-0 opacity-0 cursor-pointer" accept=".html">
              <i data-lucide="file-up" class="mx-auto mb-2 text-slate-500 group-hover:text-blue-500 transition"></i>
              <p id="base-name" class="text-[11px] text-slate-400">Drag & Drop Base HTML</p>
            </div>
          </section>

          <section>
            <div class="flex items-center justify-between mb-3">
              <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Injection Layers</label>
              <button onclick="addLayer()" class="text-[10px] font-black text-blue-500 hover:text-white transition">+ ADD LAYER</button>
            </div>
            <div id="layers-list" class="space-y-3">
              <!-- Layers go here -->
            </div>
          </section>
        </div>
      </div>

      <!-- SCAN PANEL -->
      <div id="panel-scan" class="panel">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-sm font-bold text-white">Collision Analyzer</h2>
          <button onclick="runCollisionScan()" class="px-3 py-1.5 bg-blue-600 rounded-lg text-[10px] font-bold hover:bg-blue-500 transition">RUN SCANNER</button>
        </div>
        <div id="scan-results" class="space-y-3">
          <div class="text-center py-20 opacity-30">
             <i data-lucide="radar" class="mx-auto mb-4" size="48"></i>
             <p class="text-xs uppercase tracking-widest">Aguardando Análise</p>
          </div>
        </div>
      </div>

      <!-- CODE PANEL -->
      <div id="panel-code" class="panel !p-0">
        <div id="editor-container" class="h-full"></div>
      </div>

      <!-- ACTIONS -->
      <div class="p-6 bg-black border-t border-white/5 space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <button onclick="copyCode()" class="h-12 bg-slate-900 hover:bg-slate-800 text-white rounded-xl text-xs font-bold flex items-center justify-center gap-2 border border-white/5 transition">
            <i data-lucide="copy" width="16"></i> COPY
          </button>
          <button onclick="downloadCode()" class="h-12 bg-slate-900 hover:bg-slate-800 text-white rounded-xl text-xs font-bold flex items-center justify-center gap-2 border border-white/5 transition">
            <i data-lucide="download" width="16"></i> DOWNLOAD
          </button>
        </div>
        <button onclick="toggleDeck()" class="w-full h-12 bg-blue-600 hover:bg-blue-500 text-white rounded-xl text-xs font-black tracking-widest shadow-xl shadow-blue-600/20 transition">
          EXIT ARCHITECT
        </button>
      </div>
    </div>

    <!-- PREVIEW AREA -->
    <div class="preview-area" id="preview-area">
      <div class="scan-line"></div>
      <div class="flex items-center justify-between px-2">
        <div class="flex items-center gap-4">
          <div class="flex gap-1.5">
            <div class="w-2.5 h-2.5 rounded-full bg-red-500"></div>
            <div class="w-2.5 h-2.5 rounded-full bg-yellow-500"></div>
            <div class="w-2.5 h-2.5 rounded-full bg-green-500"></div>
          </div>
          <span class="text-[9px] font-mono text-slate-500 uppercase tracking-widest" id="engine-status">SÜMBÜS Core: Idle</span>
        </div>
        <div class="flex bg-slate-900 rounded-lg p-1 border border-white/5">
          <button onclick="resizeFrame('100%')" class="p-2 hover:bg-white/5 rounded text-slate-400"><i data-lucide="monitor" width="14"></i></button>
          <button onclick="resizeFrame('390px')" class="p-2 hover:bg-white/5 rounded text-slate-400"><i data-lucide="smartphone" width="14"></i></button>
        </div>
      </div>
      <div class="flex-1 relative">
        <iframe id="main-iframe" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
      </div>
    </div>

  </div>

  <script>
    lucide.createIcons();

    // SEMANTIC Z-INDEX MAP
    const Z_LEVELS = { BASE: 0, CONTENT: 100, WIDGET: 500, OVERLAY: 1000, SYSTEM: 5000 };

    let state = {
      baseHtml: '',
      layers: [],
      finalHtml: '',
      editor: null
    };

    // --- DRAG LOGIC (IMPROVED) ---
    const trigger = document.getElementById('sumbus-trigger');
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };
    let triggerPos = { x: 20, y: 20 };

    trigger.onpointerdown = (e) => {
      isDragging = true;
      dragStart = { x: e.clientX - trigger.offsetLeft, y: e.clientY - trigger.offsetTop };
      trigger.setPointerCapture(e.pointerId);
    };

    window.onpointermove = (e) => {
      if (!isDragging) return;
      const x = e.clientX - dragStart.x;
      const y = e.clientY - dragStart.y;
      trigger.style.left = `${x}px`;
      trigger.style.top = `${y}px`;
      trigger.style.bottom = 'auto';
    };

    window.onpointerup = () => { isDragging = false; };

    trigger.onclick = () => {
       if (Math.abs(dragStart.x - (event.clientX - trigger.offsetLeft)) < 5) toggleDeck();
    };

    function toggleDeck() {
      const deck = document.getElementById('sumbus-deck');
      const isActive = deck.classList.toggle('active');
      if(isActive) updateEngine();
    }

    // --- TAB SYSTEM ---
    function showTab(tab) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(`panel-${tab}`).classList.add('active');
      event.target.classList.add('active');
      if(tab === 'code') initCM();
    }

    // --- CORE ENGINE ---
    document.getElementById('base-input').onchange = async (e) => {
      const file = e.target.files[0];
      if(!file) return;
      state.baseHtml = await file.text();
      document.getElementById('base-name').innerText = file.name;
      updateEngine();
    };

    function addLayer() {
      const id = Date.now();
      state.layers.push({ id, html: '', target: 'body', active: true, name: 'Untitled Layer' });
      renderLayers();
    }

    function renderLayers() {
      const list = document.getElementById('layers-list');
      list.innerHTML = '';
      state.layers.forEach(l => {
        const el = document.createElement('div');
        el.className = 'bg-white/5 border border-white/5 rounded-xl p-3 space-y-3';
        el.innerHTML = `
          <div class="flex items-center justify-between">
            <input type="text" value="${l.name}" onchange="updateLayerProp(${l.id}, 'name', this.value)" 
                   class="bg-transparent border-none p-0 text-[11px] font-bold text-blue-400 focus:ring-0">
            <button onclick="removeLayer(${l.id})" class="text-slate-600 hover:text-red-500"><i data-lucide="x" width="14"></i></button>
          </div>
          <div class="flex gap-2">
            <label class="flex-1 bg-slate-900 border border-white/5 rounded-lg py-1.5 text-center text-[9px] font-bold cursor-pointer hover:bg-slate-800 transition">
              LINK HTML <input type="file" class="hidden" accept=".html" onchange="loadLayerFile(${l.id}, this)">
            </label>
            <input type="text" placeholder="Target CSS" value="${l.target}" onchange="updateLayerProp(${l.id}, 'target', this.value)"
                   class="flex-1 bg-black/40 border-none rounded-lg px-2 text-[10px] font-mono text-slate-400 focus:ring-1 focus:ring-blue-500">
          </div>
        `;
        list.appendChild(el);
      });
      lucide.createIcons();
    }

    window.updateLayerProp = (id, prop, val) => {
      state.layers.find(x => x.id === id)[prop] = val;
      updateEngine();
    };

    window.loadLayerFile = async (id, input) => {
      const file = input.files[0];
      if(!file) return;
      const l = state.layers.find(x => x.id === id);
      l.html = await file.text();
      l.name = file.name.split('.')[0];
      renderLayers();
      updateEngine();
    };

    window.removeLayer = (id) => {
      state.layers = state.layers.filter(x => x.id !== id);
      renderLayers();
      updateEngine();
    };

    // --- RECURSIVE LOOP ---
    window.recursiveLoop = () => {
      if(!state.finalHtml) return;
      state.baseHtml = state.finalHtml;
      state.layers = [];
      document.getElementById('base-name').innerText = "LOOP_LAYER_" + Date.now();
      renderLayers();
      updateEngine();
      showTab('build');
    };

    // --- ENGINE MERGE & INJECTION ---
    function updateEngine() {
      if(!state.baseHtml) return;
      const parser = new DOMParser();
      const doc = parser.parseFromString(state.baseHtml, 'text/html');

      // Inject Semantic Z-Index Rules
      const zStyle = doc.createElement('style');
      zStyle.textContent = `
        :root {
          --z-base: ${Z_LEVELS.BASE};
          --z-content: ${Z_LEVELS.CONTENT};
          --z-widget: ${Z_LEVELS.WIDGET};
          --z-overlay: ${Z_LEVELS.OVERLAY};
          --z-system: ${Z_LEVELS.SYSTEM};
        }
      `;
      doc.head.appendChild(zStyle);

      // Ingest Layers
      state.layers.forEach(l => {
        if(!l.html) return;
        const lDoc = parser.parseFromString(l.html, 'text/html');
        
        // Styles
        Array.from(lDoc.querySelectorAll('style, link[rel="stylesheet"]')).forEach(s => doc.head.appendChild(s.cloneNode(true)));
        
        // Body Content
        const target = doc.querySelector(l.target) || doc.body;
        const frag = doc.createDocumentFragment();
        Array.from(lDoc.body.childNodes).forEach(n => frag.appendChild(n.cloneNode(true)));
        target.appendChild(frag);

        // Scripts
        Array.from(lDoc.querySelectorAll('script')).forEach(s => {
          const ns = doc.createElement('script');
          Array.from(s.attributes).forEach(a => ns.setAttribute(a.name, a.value));
          ns.textContent = s.textContent;
          doc.body.appendChild(ns);
        });
      });

      state.finalHtml = doc.documentElement.outerHTML;
      document.getElementById('main-iframe').srcdoc = state.finalHtml;
      document.getElementById('engine-status').innerText = 'Engine: Synchronized';
    }

    // --- COLLISION SCANNER (SPATIAL ANALYZER) ---
    async function runCollisionScan() {
      const area = document.getElementById('preview-area');
      const iframe = document.getElementById('main-iframe');
      const resultsContainer = document.getElementById('scan-results');
      
      area.classList.add('scanning');
      resultsContainer.innerHTML = '<div class="text-center py-10 animate-pulse text-xs text-blue-400">VARRENDO ÁREA ESPACIAL...</div>';

      await new Promise(r => setTimeout(r, 1500)); // Simulate processing

      const frameDoc = iframe.contentDocument || iframe.contentWindow.document;
      const elements = Array.from(frameDoc.querySelectorAll('*')).filter(el => {
        const s = frameDoc.defaultView.getComputedStyle(el);
        return s.position !== 'static' && el.id;
      });

      const conflicts = [];
      const rects = elements.map(el => ({
        el,
        id: el.id,
        rect: el.getBoundingClientRect(),
        z: parseInt(frameDoc.defaultView.getComputedStyle(el).zIndex) || 0
      }));

      // Detect Overlaps
      for (let i = 0; i < rects.length; i++) {
        for (let j = i + 1; j < rects.length; j++) {
          const a = rects[i];
          const b = rects[j];
          
          const isOverlapping = !(a.rect.right < b.rect.left || a.rect.left > b.rect.right || a.rect.bottom < b.rect.top || a.rect.top > b.rect.bottom);
          
          if(isOverlapping) {
            conflicts.push({ a, b, level: a.z === b.z ? 'CRITICAL' : 'WARNING' });
          }
        }
      }

      area.classList.remove('scanning');
      renderScanResults(conflicts);
    }

    function renderScanResults(conflicts) {
      const container = document.getElementById('scan-results');
      container.innerHTML = '';
      
      if(conflicts.length === 0) {
        container.innerHTML = '<div class="text-center py-10 text-green-500 font-bold text-xs"><i data-lucide="check-circle" class="mx-auto mb-2"></i>ÁREA LIMPA: SEM CONFLITOS</div>';
      } else {
        conflicts.forEach(c => {
          const div = document.createElement('div');
          div.className = `conflict-card ${c.level === 'CRITICAL' ? 'border-red-500/50 bg-red-500/5' : 'border-yellow-500/50 bg-yellow-500/5'}`;
          div.innerHTML = `
            <div class="flex justify-between items-center mb-2">
              <span class="status-badge ${c.level === 'CRITICAL' ? 'bg-red-500 text-white' : 'bg-yellow-500 text-black'}">${c.level}</span>
              <span class="text-[9px] text-slate-500 font-mono">Z-INDEX COLLISION</span>
            </div>
            <p class="text-[11px] text-slate-300 font-bold">#${c.a.id} <span class="text-slate-500">vs</span> #${c.b.id}</p>
            <p class="text-[9px] text-slate-500 mt-1">Ambos estão em Z:${c.a.z}. Isso pode bloquear interações.</p>
          `;
          container.appendChild(div);
        });
      }
      lucide.createIcons();
    }

    // --- CODE VIEW ---
    function initCM() {
      if(!state.editor && window.CM) {
        state.editor = new CM.EditorView({
          doc: state.finalHtml,
          extensions: [CM.basicSetup, CM.html(), CM.oneDark, CM.EditorView.editable.of(false)],
          parent: document.getElementById('editor-container')
        });
      } else if(state.editor) {
        state.editor.dispatch({ changes: {from: 0, to: state.editor.state.doc.length, insert: state.finalHtml} });
      }
    }

    // --- EXPORTS ---
    window.copyCode = async () => {
      await navigator.clipboard.writeText(state.finalHtml);
      const b = event.target;
      b.innerText = 'COPIED!';
      setTimeout(() => { b.innerHTML = '<i data-lucide="copy" width="16"></i> COPY'; lucide.createIcons(); }, 1000);
    };

    window.downloadCode = () => {
      const blob = new Blob([state.finalHtml], {type: 'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'sumbus-system-final.html';
      a.click();
    };

    window.resizeFrame = (w) => document.getElementById('main-iframe').style.maxWidth = w;

  </script>
</body>
</html>

